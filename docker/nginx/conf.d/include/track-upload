# register the upload in accounts service (cookies should contain jwt)
log_by_lua_block {
    -- this block runs only when accounts are enabled
    if os.getenv("ACCOUNTS_ENABLED") ~= "true" then return end

    local skylink = ngx.header["Skynet-Skylink"]
    if skylink and ngx.status >= ngx.HTTP_OK and ngx.status < ngx.HTTP_SPECIAL_RESPONSE then
        local http = require("socket.http")
        local ok, statusCode, headers, statusText = http.request {
            url = "http://accounts:3000/track/upload/" .. skylink,
            method = "POST",
            headers = ngx.req.get_headers()
        }
        if statusCode ~= ngx.HTTP_NO_CONTENT and statusCode ~= ngx.HTTP_UNAUTHORIZED then
            ngx.log(ngx.ERR, "accounts endpoint /track/upload/" .. skylink .. " failed with error " .. statusCode)
        end
    end
}
